<!DOCTYPE html>
<html>
    <head>
        <title>JetBrains artwork creator</title>
        <meta charset="utf-8" />

        <!-- RPD: css -->
        <link rel="stylesheet" href="./rpd.css"></link>
        <!-- Toolkit: jb (svg) -->
        <link rel="stylesheet" href="./toolkit/jb/svg.css"></link>

        <!-- Kefir.js library -->
        <script src="./kefir.min.js"></script>

        <!-- RPD Library (http://shamansir.github.io/rpd) -->
        <script src="./rpd.min.js"></script>

        <!-- Toolkit: jb, utils -->
        <script src="./toolkit/jb/shared.js"></script>
        <!-- Toolkit: jb -->
        <script src="./toolkit/jb/toolkit.js"></script>
        <!-- Toolkit: jb (svg) -->
        <script src="./toolkit/jb/svg.js"></script>

        <!-- p5.js -->
        <script src="./p5.min.js"></script>
        <script src="./p5.dom.js"></script>

        <!-- d3.v4.min.js -->
        <script src="./d3.v4.min.js"></script>
        <!-- d3.voronoi.js -->
        <script src="./d3-voronoi.v1.min.js"></script>

        <style>
            body {
                margin: 0;
                padding: 0;
            }

            #overlay {
                background-color: rgba(0,0,0,0.5);
                opacity: 1;
                transition: opacity 500ms ease-in;
            }

            #overlay.hidden {
                opacity: 0;
            }

            #patch-target {
                opacity: 1;
                transition: opacity 500ms ease-in;
            }

            #patch-target.hidden {
                opacity: 0;
            }

            #patch-target .rpd-background {
                /* fill: transparent; */
                opacity: 0.3;
            }

            #rpd-jb-preview-target {
                position: fixed;
            }

            #rpd-jb-preview-target,
            #rpd-jb-preview-target canvas {
                background: #12181C;
            }

            #front-layer {
                position: relative;
            }

            .rpd-node .rpd-content {
                opacity: 0.85;
            }

            .rpd-node.rpd-jb-save .rpd-process * {
                pointer-events: all;
                cursor: pointer;
            }



            .rpd-node.rpd-util-comment .rpd-process text {
                fill: white;
                font-size: 1.5em;
            }

            .rpd-node.rpd-jb-palette .rpd-process .rpd-jb-palette-variant * {
                pointer-events: all;
                cursor: pointer;
            }

            .rpd-node.rpd-jb-palette .rpd-process .rpd-jb-product-label {
                font-size: 7px;
                font-weight: bold;
            }

            .rpd-jb-active-label {
                fill: white;
            }

            .rpd-jb-palette-variant.rpd-jb-active-variant {
                stroke: white;
            }

            .rpd-node.rpd-util-comment {
                text-anchor: middle;
                /* alignment-baseline: hanging; */
            }

            #p5_loading {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: aliceblue;
            }

            #loading-bar {
                position: absolute;
                top: 0;
                width: 0%;
                height: 20px;
                background-color: navajowhite;
                display: none;
                /* background-color: rgba(255, 0, 0, 0.7); */
            }

        </style>

        <link rel="stylesheet" href="./loaders.min.css"></link>

        <style>
            #loader-wrapper {
                position: absolute;
                left: 50%;
                top: 30px;
                font-family: sans-serif;
                color: white;
                margin-left: -120px;
                /* transition: opacity 500ms ease-out; */
            }

            #loader-wrapper p {
                position: relative;
                left: 80px;
                /* text-align: center; */
                font-size: 1.5em;
            }

            #loader-wrapper .ball-rotate {
                left: 30px;
                top: 45px;
            }
        </style>

    </head>
    <body>

        <div id="rpd-jb-preview-target"></div>
        <div id="front-layer">
            <div id="loader-wrapper">
                <div id="loader" class="loader-inner ball-rotate"><div></div></div>
                <p>Loading...</p>
            </div>
            <div id="overlay"></div>
            <div id="patch-target"></div>
            <div id="loading-bar"></div>
        </div>

        <script>
            // window.___sketchUpdateProxy = function(config) {
            window.updateSketchConfig = function(config) {
                window.missedSketchConfig = config;
            }; // sketch will replace it later
        </script>

        <script>

            // ============= Build and render patch =============

            d3.select('#loader-wrapper').style('opacity', '0');

            var patch = Rpd.addPatch('jb-sketch');

            patch.render('svg', document.getElementById('patch-target'),
                         { style: 'ableton-out',
                           fullPage: true,
                           linkForm: 'curve' });

            var bangX = 50;
            var bangY = 50;

            var topMargin = window.innerHeight - 500;
            var leftMargin = window.innerWidth/2 - 700;

            patch.addNode('jb/clear').move(leftMargin + 1061,topMargin + 112);

            patch.addNode('util/nodelist').move(leftMargin + 1210,topMargin + 171);

            var layersNode = patch.addNode('jb/layers').move(leftMargin + 1058,topMargin + 174);

            var commentRemoved = false;

            var commentNode = patch.addNode('util/comment').move(window.innerWidth/2 - 50, -60);
            commentNode.inlets['text'].receive('Press SPACE to hide nodes and show background');

            var previewTarget = document.getElementById('rpd-jb-preview-target');
            previewTarget.style.width = window.innerWidth + 'px';
            previewTarget.style.height = window.innerHeight + 'px';

            Kefir.fromEvents(document.body, 'keydown').filter(function(evt) {
                return evt.keyCode === 32;
            }).onValue(function(evt) {
                evt.preventDefault();
            });

            var overlayElm = document.getElementById('overlay');
            var patchElm = document.getElementById('patch-target');
            Kefir.fromEvents(document.body, 'keydown').filter(function(evt) {
                return evt.keyCode === 32;
            }).scan(function(prev, next) {
                return !prev;
            }, true).onValue(function(value) {
                overlayElm.className = value ? 'visible' : 'hidden';
                patchElm.className = value ? 'visible' : 'hidden';
                if (!value && !commentRemoved) {
                    patch.removeNode(commentNode);
                    commentRemoved = true;
                }
            });



            var previewNode = patch.addNode('jb/preview').move(leftMargin + 1210, topMargin + 89);
            var saveNode = patch.addNode('jb/save').move(leftMargin + 1303, topMargin - 6);

            var bangNode = patch.addNode('util/bang').move(bangX, bangY);

            var paletteNode = patch.addNode('jb/palette').move(leftMargin + 129, topMargin + 394);
            var drawLogoNode = patch.addNode('jb/draw-logo').move(leftMargin + 944, topMargin + 376);
            var rorschachNode = patch.addNode('jb/rorschach').move(leftMargin + 252, topMargin + 285);
            var rorschachVerticalNode = patch.addNode('jb/rorschach-vertical').move(leftMargin + 253, topMargin + 205);

            var noiseNode = patch.addNode('jb/noise').move(leftMargin + 127, topMargin + 258);
            var backgroundNode = patch.addNode('jb/background').move(leftMargin + 130, topMargin + 147);

            var octaveNoiseNode = patch.addNode('util/dial', 'Octaves').move(leftMargin + 29, topMargin + 310);
            octaveNoiseNode.inlets['max'].receive(10);
            octaveNoiseNode.inlets['submit'].receive(0.4);

            var falloffNoiseNode = patch.addNode('util/knob', 'Falloff').move(leftMargin + 33, topMargin + 408);
            falloffNoiseNode.inlets['max'].receive(1);


            var noiseStep = patch.addNode('util/dial', 'Step').move(leftMargin + 31, topMargin + 214);
            noiseStep.inlets['max'].receive(100);
            noiseStep.inlets['min'].receive(1);
            noiseStep.inlets['submit'].receive(1/10);

            var collectPointDataNode = patch.addNode('jb/collect-point-data').move(leftMargin + 370,topMargin + 187);

            var drawPixelsNode = patch.addNode('jb/draw-pixels').move(leftMargin + 383, topMargin + 325);
            var applyGradientNode = patch.addNode('jb/apply-gradient').move(leftMargin + 749, topMargin + 433);
            var voronoiNode = patch.addNode('jb/voronoi').move(leftMargin + 496, topMargin + 127);
            var edgesSquaresNode = patch.addNode('jb/edges-squares').move(leftMargin + 625, topMargin + 185);
            var curvedEdgesNode = patch.addNode('jb/curved-edges').move(leftMargin + 891, topMargin + 114);
            var backEdgesSquaresNode = patch.addNode('jb/back-edges-squares').move(leftMargin + 783, topMargin + 286);
            var shapesNode = patch.addNode('jb/shapes').move(leftMargin + 779, topMargin + 171);
            var vignetteNode = patch.addNode('jb/vignette').move(leftMargin + 571, topMargin + 365);

            paletteNode.outlets['palette'].connect(applyGradientNode.inlets['palette']);
            paletteNode.outlets['palette'].connect(vignetteNode.inlets['palette']);
            paletteNode.outlets['product'].connect(drawLogoNode.inlets['product']);
            paletteNode.outlets['palette'].connect(edgesSquaresNode.inlets['palette']);
            octaveNoiseNode.outlets['number'].connect(noiseNode.inlets['octave']);
            falloffNoiseNode.outlets['number'].connect(noiseNode.inlets['falloff']);
            noiseStep.outlets['number'].connect(noiseNode.inlets['step']);
            voronoiNode.outlets['voronoi'].connect(edgesSquaresNode.inlets['voronoi']);
            rorschachNode.outlets['pixels'].connect(edgesSquaresNode.inlets['pixels']);
            voronoiNode.outlets['voronoi'].connect(curvedEdgesNode.inlets['voronoi']);
            voronoiNode.outlets['voronoi'].connect(shapesNode.inlets['voronoi']);
            //paletteNode.outlets['product'].connect(backgroundNode.inlets['product']);

            collectPointDataNode.outlets['points'].connect(voronoiNode.inlets['points']);
            collectPointDataNode.outlets['points'].connect(backEdgesSquaresNode.inlets['points']);
            rorschachNode.outlets['pixels'].connect(collectPointDataNode.inlets['pixels']);

            bangNode.outlets['bang'].connect(noiseNode.inlets['bang']);
//
            noiseNode.outlets['pixels'].connect(rorschachNode.inlets['pixels']);
            // noiseNode.outlets['pixels'].connect(rorschachVerticalNode.inlets['pixels']);
            rorschachNode.outlets['pixels'].connect(drawPixelsNode.inlets['pixels']);
            //  rorschachVerticalNode.outlets['pixels'].connect(drawPixelsNode.inlets['pixels']);

            drawPixelsNode.outlets['drawable'].connect(layersNode.inlets['layer-1']);
            applyGradientNode.outlets['drawable'].connect(layersNode.inlets['layer-2']);
            curvedEdgesNode.outlets['drawable'].connect(layersNode.inlets['layer-3']);
            shapesNode.outlets['drawable'].connect(layersNode.inlets['layer-4']);
            edgesSquaresNode.outlets['drawable'].connect(layersNode.inlets['layer-5']);
            backEdgesSquaresNode.outlets['drawable'].connect(layersNode.inlets['layer-6']);
            vignetteNode.outlets['drawable'].connect(layersNode.inlets['layer-7']);
            drawLogoNode.outlets['drawable'].connect(layersNode.inlets['layer-8']);

            layersNode.outlets['layers'].connect(previewNode.inlets['layers']);

            previewNode.outlets['image'].connect(saveNode.inlets['image']);

            //randomNode.inlets['min'].receive(12);
            //randomNode.inlets['max'].receive(40);

          //  randomNode.outlets['random'].connect(configNode.inlets['step']);

            //setTimeout(function() {
             //   metroNode.outlets['bang'].connect(randomNode.inlets['bang']);
            //}, 2000);
            setTimeout(function() {
               bangNode.outlets['bang'].send({});
            }, 2000);

        </script>

        <!-- p5.js -->
        <script src="./p5.min.js"></script>
        <!-- <script src="./p5.dom.js"></script> -->
        <!-- p5 Sketch -->
        <script src="./sketch.p5.js"></script>

        <script>
            window.addEventListener('load', function() {
                /* window.___sketchUpdateProxy = function(config) {
                    // uses a global function from the sketch
                    updateSketchConfig(config);
                }; */

                //if (window.missedSketchConfig) window.___sketchUpdateProxy(window.missedSketchConfig);
                if (window.missedSketchConfig) window.updateSketchConfig(window.missedSketchConfig);
            });
        </script>

    </body>
</html>
